<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Prenotazione Campo Tennis</title>
<style>
body { font-family: Arial, sans-serif; margin: 40px; }
.slots { display: flex; gap: 10px; flex-wrap: wrap; }
.slot { padding: 10px 16px; border: 1px solid #333; cursor: pointer; }
.slot.selected { background: #4CAF50; color: white; }
</style>
</head>

<body>
<h1>Prenota il campo</h1>

<label>Data:</label>
<input type="date" id="date">

<div id="slots" class="slots"></div>

<hr>

<input id="name" placeholder="Nome"><br>
<input id="phone" placeholder="Telefono"><br>
<input id="email" placeholder="Email"><br><br>

<button id="pay">Prenota e Paga</button>

<script>
let selectedSlot = null;
let bookingId = null;

date.addEventListener("change", async () => {
    selectedSlot = null;
    slots.innerHTML = "";

    const res = await fetch(`/slots?date=${date.value}`);
    const data = await res.json();

    if (data.length === 0) {
        slots.innerHTML = "<p>Nessuno slot disponibile</p>";
        return;
    }

    data.forEach(time => {
        const b = document.createElement("div");
        b.className = "slot";
        b.textContent = time;
        b.onclick = () => {
            document.querySelectorAll(".slot").forEach(x => x.classList.remove("selected"));
            b.classList.add("selected");
            selectedSlot = time;
        };
        slots.appendChild(b);
    });
});

pay.onclick = async () => {
    if (!date.value || !selectedSlot || !name.value || !phone.value || !email.value) {
        alert("Compila tutti i campi");
        return;
    }

    // prenotazione
    const r = await fetch("/reserve", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            date: date.value,
            time: selectedSlot,
            name: name.value,
            phone: phone.value,
            email: email.value
        })
    });

    const d = await r.json();
    bookingId = d.booking_id;

    // checkout
    const p = await fetch("/create-checkout-session", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ booking_id: bookingId })
    });

    const s = await p.json();
    window.location.href = s.url;
};
</script>
</body>
</html>
