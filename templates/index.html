<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Prenotazione Campo Tennis</title>
<style>
body { font-family: Arial, sans-serif; margin: 40px; }
.slots { display: flex; gap: 10px; flex-wrap: wrap; }
.slot { padding: 10px 16px; border: 1px solid #333; cursor: pointer; }
.slot.selected { background: #4CAF50; color: white; }
</style>
</head>

<body>
<h1>GTC CASTEGNATO 
Prenota il tuo campo</h1>

<label>Data:</label>
<input type="date" id="date">

<div id="slots" class="slots"></div>

<hr>

<input id="name" placeholder="Nome"><br>
<input id="phone" placeholder="Telefono"><br>
<input id="email" placeholder="Email"><br>
<body>
<h1>Cauzione $10</h1>
<button id="pay">Prenota e Paga</button>

<script>
let selectedSlot = null;

const dateInput = document.getElementById("date");
const slotsDiv = document.getElementById("slots");
const payBtn = document.getElementById("pay");

dateInput.addEventListener("change", async () => {
    selectedSlot = null;
    slotsDiv.innerHTML = "";

    try {
        const res = await fetch(`/slots?date=${dateInput.value}`);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
            slotsDiv.innerHTML = "<p>Nessuno slot disponibile</p>";
            return;
        }

        data.forEach(time => {
            const btn = document.createElement("button");
            btn.textContent = time;
            btn.className = "slot";
            btn.onclick = () => {
                document.querySelectorAll(".slot").forEach(b => b.classList.remove("selected"));
                btn.classList.add("selected");
                selectedSlot = time;
            };
            slotsDiv.appendChild(btn);
        });
    } catch (e) {
        alert("Errore caricamento slot");
        console.error(e);
    }
});

payBtn.addEventListener("click", async () => {
    const date = dateInput.value;
    const name = document.getElementById("name").value;
    const phone = document.getElementById("phone").value;
    const email = document.getElementById("email").value;

    if (!date || !selectedSlot || !name || !phone || !email) {
        alert("Compila tutti i campi e seleziona uno slot");
        return;
    }

    try {
        // 1. RESERVE
        const reserveRes = await fetch("/reserve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                date,
                time: selectedSlot,
                name,
                phone,
                email
            })
        });

        const reserveData = await reserveRes.json();
        if (!reserveRes.ok) {
            alert(reserveData.error || "Errore prenotazione");
            return;
        }

        // 2. CHECKOUT
        const checkoutRes = await fetch("/create-checkout-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ booking_id: reserveData.booking_id })
        });

        const checkoutData = await checkoutRes.json();
        if (!checkoutRes.ok || !checkoutData.url) {
            alert("Errore pagamento");
            return;
        }

        // 3. REDIRECT STRIPE
        window.location.href = checkoutData.url;

    } catch (e) {
        alert("Errore di comunicazione col server");
        console.error(e);
    }
});
</script>

</body>
</html>
